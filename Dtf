import { Component, Input, Output, EventEmitter, OnChanges, SimpleChanges } from '@angular/core';
import { FormBuilder } from '@angular/forms';

@Component({
  selector: 'app-report-date-filter',
  templateUrl: './report-date-filter.component.html',
  styleUrls: ['./report-date-filter.component.scss']
})
export class ReportDateFilterComponent implements OnChanges {

  @Input() dates: string[] = [];   // incoming YYYY-MM-DD strings
  @Output() selectionChange = new EventEmitter<{ months: string[], days: string[] }>();

  monthKeys: string[] = [];
  days: string[] = [];

  form = this.fb.group({
    months: [[] as string[]],
    days:   [{ value: [] as string[], disabled: true }]
  });

  constructor(private fb: FormBuilder) {}

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['dates']) {
      this.buildMonthKeys();
    }
  }

  private buildMonthKeys() {
    this.monthKeys = Array.from(
      new Set(this.dates.map(d => d.substring(0, 7)))  // YYYY-MM
    ).sort();

    // Reset selections when new data arrives
    this.form.patchValue({ months: [], days: [] }, { emitEvent: false });
    this.form.get('days')!.disable({ emitEvent: false });
  }

  ngOnInit() {
    this.form.get('months')!.valueChanges.subscribe(months => this.onMonthsChange(months as string[]));
    this.form.get('days')!.valueChanges.subscribe(days => this.emitSelection());
  }

  private onMonthsChange(selectedMonths: string[]) {
    // Reset day filter
    this.form.patchValue({ days: [] }, { emitEvent: false });

    if (!selectedMonths.length) {
      this.form.get('days')!.disable({ emitEvent: false });
      this.days = [];
      this.emitSelection();
      return;
    }

    // Enable day dropdown
    this.form.get('days')!.enable({ emitEvent: false });

    // Extract distinct days based on selected month keys
    this.days = Array.from(
      new Set(
        this.dates
          .filter(d => selectedMonths.includes(d.substring(0, 7)))
          .map(d => d.substring(8, 10))
      )
    ).sort();

    this.emitSelection();
  }

  // Emit selection to parent
  private emitSelection() {
    this.selectionChange.emit({
      months: this.form.value.months as string[],
      days:   this.form.value.days   as string[]
    });
  }
}
