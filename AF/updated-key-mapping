private optionsCache = new Map<string, string[]>();
isOptionsLoading = false;

private loadAllColumnOptions(): void {
  if (!this.columns?.length) return;

  this.isOptionsLoading = true;

  const calls = this.columns.map(col => {
    // cache
    const cached = this.optionsCache.get(col.columnKey);
    if (cached) return of(cached);

    const db = col.meta.targetDatabase;
    const schema = col.meta.targetSchema;
    const table = col.meta.targetTable;

    return this._apiService
      .getData(`target-table/metadata?database_name=${db}&schema_name=${schema}&table_name=${table}&type=column`)
      .pipe(
        map((resp: any) => {
          const rows = resp?.data ?? [];
          return rows
            .map((r: any) => r?.name)
            .filter((v: any): v is string => !!v);
        }),
        catchError(() => of([] as string[]))
      );
  });

  forkJoin(calls).subscribe((results: string[][]) => {
    results.forEach((opts, idx) => {
      const col = this.columns[idx];
      this.optionsCache.set(col.columnKey, opts);
      col.options = opts; // âœ… this is what your HTML already uses
    });

    // Force mat-table refresh
    this.columns = [...this.columns];
    this.rows = [...this.rows];

    this.isOptionsLoading = false;
  });
}
