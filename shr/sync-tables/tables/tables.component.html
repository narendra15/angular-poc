<div class="container">
    <!-- LEFT -->
    <section class="left">
      <header class="left-header">
        <h2>Input Tables</h2>
        <label class="year-select">
          <span>Select Year</span>
          <select [value]="svc.currentYear()"
                  (change)="onYearChange($any($event.target).value)"
                  [disabled]="readonlyMode">
            <option *ngFor="let y of svc.years()" [value]="y">{{ y }}</option>
          </select>
        </label>
      </header>
  
      <ng-container *ngIf="svc.monthsForCurrentYear().length; else noData">
        <div class="months-grid">
          <div class="month-card"
               *ngFor="let m of svc.monthsForCurrentYear()"
               [class.changed]="!readonlyMode && m.changed">
            <div class="month-title">
              {{ svc.monthLabel(m.month) }} {{ m.year }}
            </div>
  
            <label class="toggle">
              <input type="checkbox"
                     [checked]="m.checked"
                     (change)="toggle(m.month)"
                     [disabled]="readonlyMode" />
              <span class="status-chip" [class.on]="m.checked" [class.off]="!m.checked">
                {{ svc.statusCode(m.checked) }}
              </span>
            </label>
  
            <div class="status-text">{{ svc.statusText(m.checked) }}</div>
  
            <!-- NEW: timestamp display -->
            <div class="ts">Last updated: {{ m.ts }}</div>
          </div>
        </div>
      </ng-container>
  
      <ng-template #noData>
        <div class="no-data">No data available for {{ svc.currentYear() }}.</div>
      </ng-template>
    </section>
  
    <!-- RIGHT (hidden for Preparer) -->
    <section class="right" *ngIf="!readonlyMode">
      <header class="right-header">
        <h2>Pending Changes</h2>
        <div class="actions">
          <button class="btn secondary" type="button"
                  (click)="clearAll()"
                  [disabled]="svc.pendingDeltas().length === 0">Clear All</button>
          <button class="btn primary" type="button"
                  (click)="apply()"
                  [disabled]="svc.pendingDeltas().length === 0">Apply Changes</button>
        </div>
      </header>
  
      <div *ngIf="svc.pendingDeltas().length === 0" class="empty">No pending changes.</div>
  
      <div class="pending-list" *ngIf="svc.pendingDeltas().length > 0">
        <div class="year-group" *ngFor="let group of (svc.pendingByYear() | keyvalue: yearDesc)">
          <div class="year-title">{{ group.key }}</div>
          <ul>
            <li *ngFor="let row of group.value">
              <span class="m">{{ svc.monthLabel(row.month) }}</span>
              <span class="arrow">→</span>
              <span class="code">{{ row.to ? 'Y' : 'N' }}</span>
              <span class="text">({{ row.to ? 'Included (Y)' : 'Removed (N)' }})</span>
              <!-- show ts here too -->
              <span class="ts-inline">• {{ row.ts }}</span>
  
              <button class="btn tiny" type="button"
                      (click)="removePending(group.key, row.month)">
                Remove
              </button>
            </li>
          </ul>
        </div>
      </div>
  
      <div class="footer-note">
        Note: Changes aren’t saved until you click <b>Apply Changes</b>.
      </div>
    </section>
  </div>
  